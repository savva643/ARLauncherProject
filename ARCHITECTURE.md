# Архитектура проекта ARLauncherProject

## Обзор

Проект разделен на 3 независимых компонента, каждый со своей ответственностью.

## 🏗️ Архитектурная схема

```
┌─────────────────────────────────────────────────────────┐
│                    iPhone (Источник данных)             │
│  - RGB Camera (0x01)                                    │
│  - LiDAR Depth (0x02)                                    │
│  - Raw IMU (0x03)                                        │
│  - Feature Points (0x04)                                 │
│  - Camera Intrinsics (0x05)                              │
│  - Light Estimation (0x06)                              │
└────────────────────┬────────────────────────────────────┘
                      │ USB / WiFi (TCP/UDP)
                      ▼
┌─────────────────────────────────────────────────────────┐
│              SensorConnector (Qt Component)              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ UsbManager   │  │ NetworkServer│  │  Decoders    │   │
│  │ USB Ethernet│  │  TCP/UDP     │  │ TurboJPEG    │   │
│  └──────────────┘  └──────────────┘  │ FFmpeg      │   │
│                                       │ FastJPEG    │   │
│                                       └──────────────┘   │
│  Выход: Сырые данные (SensorData)                        │
└────────────────────┬────────────────────────────────────┘
                      │ Сырые данные
                      ▼
┌─────────────────────────────────────────────────────────┐
│              LensEngineSDK (Pure C++)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │SensorFusionEKF│  │ARDataProcessor│  │Lidar3DProcessor│ │
│  │  EKF Filter   │  │  Feature     │  │  Spatial     │ │
│  │  6DoF Pose    │  │  Detection   │  │  Analysis    │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
│  ┌──────────────┐  ┌──────────────┐                   │
│  │CameraController│ │SpatialMapping│                   │
│  │  Camera Pose  │  │  Virtual     │                   │
│  │  Management   │  │  Objects     │                   │
│  └──────────────┘  └──────────────┘                   │
│  Выход: CameraPose (6DoF поза камеры)                   │
└────────────────────┬────────────────────────────────────┘
                      │ CameraPose
                      ▼
┌─────────────────────────────────────────────────────────┐
│              ARLauncher (Native C++)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  Renderer    │  │    Scene     │  │   Camera     │ │
│  │ OpenGL/Vulkan│  │  3D Objects  │  │  Virtual     │ │
│  │              │  │              │  │  (synced)    │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
│  ┌──────────────┐  ┌──────────────┐                   │
│  │ UIRenderer   │  │ Custom UI   │                   │
│  │  UI Elements │  │  Button/Text │                   │
│  └──────────────┘  └──────────────┘                   │
│  Выход: Рендеринг на экран                              │
└─────────────────────────────────────────────────────────┘
```

## 📦 Компоненты

### 1. SensorConnector

**Ответственность:**
- Получение данных от iPhone через USB/WiFi
- Декодирование JPEG/H.264
- Передача сырых данных дальше

**Технологии:**
- Qt (core, network, concurrent)
- libjpeg-turbo
- FFmpeg

**Интерфейс:**
```cpp
SensorConnectorCore::dataReceived(SensorData)
```

**Независимость:**
- ✅ Не зависит от AR компонентов
- ✅ Не зависит от LensEngineSDK
- ✅ Не зависит от ARLauncher

### 2. LensEngineSDK

**Ответственность:**
- Обработка всех типов AR данных
- Сенсорный фьюжн (EKF)
- Вычисление 6DoF позы камеры
- Пространственное маппирование

**Технологии:**
- Чистый C++17
- GLM (математика)
- OpenCV (опционально, для feature detection)

**Интерфейс:**
```cpp
LensEngineAPI::processRGBData(...)
LensEngineAPI::processIMUData(...)
LensEngineAPI::processLidarData(...)
LensEngineAPI::getCurrentCameraPose()
```

**Независимость:**
- ✅ Не зависит от Qt
- ✅ Не зависит от SensorConnector
- ✅ Не зависит от ARLauncher
- ✅ Может использоваться в любом C++ проекте

### 3. ARLauncher

**Ответственность:**
- Рендеринг 3D сцены
- Отображение видео-фона
- Custom UI система
- Синхронизация виртуальной камеры

**Технологии:**
- Native C++17
- GLFW (окно)
- Vulkan/OpenGL (рендеринг)
- GLM (математика)

**Зависимости:**
- LensEngineSDK (для получения позы камеры)
- SensorConnector (опционально, для прямого получения данных)

## 🔄 Поток данных

### Полный цикл:

1. **iPhone** → отправляет данные через USB/WiFi
2. **SensorConnector** → получает, декодирует JPEG
3. **SensorConnector** → отправляет сырые данные через сигналы
4. **LensEngineSDK** → обрабатывает:
   - RGB → Feature Points
   - IMU → EKF → 6DoF поза
   - LiDAR → 3D точки → Пространственное маппирование
5. **LensEngineSDK** → выдает позу камеры через колбэки
6. **ARLauncher** → обновляет виртуальную камеру
7. **ARLauncher** → рендерит:
   - Видео-фон (RGB кадр)
   - 3D объекты (синхронизированные с реальным миром)
   - Custom UI элементы

## 🎯 Принципы проектирования

### Разделение ответственности

- **SensorConnector**: Только получение и декодирование данных
- **LensEngineSDK**: Только обработка AR данных
- **ARLauncher**: Только рендеринг и UI

### Независимость компонентов

Каждый компонент может:
- Собираться независимо
- Использоваться в других проектах
- Тестироваться отдельно

### Интерфейсы

- **SensorConnector → LensEngineSDK**: `SensorData` структура
- **LensEngineSDK → ARLauncher**: `CameraPose` структура
- Все интерфейсы через чистые C++ типы (без Qt в LensEngineSDK)

## 📊 Производительность

### Оптимизации:

1. **SensorConnector**:
   - Многопоточное декодирование JPEG
   - Асинхронная обработка данных

2. **LensEngineSDK**:
   - EKF фильтр оптимизирован для реального времени
   - Быстрая обработка LiDAR (каждый 4-й пиксель)
   - Асинхронная обработка кадров

3. **ARLauncher**:
   - Эффективный рендерер (OpenGL/Vulkan)
   - Легковесная Custom UI система
   - Минимальные накладные расходы

## 🔐 Безопасность

- Все компоненты изолированы
- Нет общих глобальных состояний
- Потокобезопасность через mutex/std::atomic
- Валидация входных данных

## 📝 Расширяемость

### Добавление новых типов данных:

1. Добавить в `SensorDataTypes.h` (SensorConnector)
2. Добавить обработку в `LensEngineSDK`
3. Добавить визуализацию в `ARLauncher` (если нужно)

### Добавление новых UI элементов:

1. Наследовать от `UIElement`
2. Реализовать `render()` и обработчики событий
3. Добавить в `UIRenderer`

### Добавление новых алгоритмов AR:

1. Добавить в `LensEngineSDK`
2. Экспортировать через `LensEngineAPI`
3. Использовать в `ARLauncher`

---

**Принципы архитектуры:** Модульность, Независимость, Расширяемость, Производительность

